#!/bin/bash

##########################
# Cleans up disk space by deleting all files generated by maven in all the directories under the root directory.
#
# Usage: clean-maven-projects <root directory>
#
##########################

if [[ "n$1" = n ]]
  then
    DIR=`pwd`
  else
    DIR="$1"
    shift 1
fi

if [[ "n$1" = n-f ]]
  then
    FORCE=true
  else
    FORCE=false
fi



# using mvn clean:
# find "$DIR" -name pom.xml -exec mvn clean -fae -N -o -f {} \; | tee -a /tmp/clean-maven-projects.log

# using rm -rf target:
DELETED=
FALSE_ALARM=
find "$DIR" -name target -exec echo {} \; 2> /dev/null | {
    while read line
      do
        if [[ -f `dirname "$line"`/pom.xml ]]
          then
            if [[ $FORCE = true ]]
              then
                if rm -rf "$line"
                  then
                    DELETED="$DELETED""> $line\n"
                  else
                    FAILED="$FAILED""> $line\n"
                fi
              else
                echo To be deleted: "$line". Use -f argument to delete
            fi
          else
            FALSE_ALARM="$FALSE_ALARM""> $line\n"
        fi
    done

    if [[ "n$FALSE_ALARM" != n ]]
      then
        echo "-----------------"
        echo "FALSE ALARMS:"
        echo -e "$FALSE_ALARM"
    fi

    if [[ "n$DELETED" = n ]]
      then
        echo NOTHING DELETED
      else
        echo "DELETED:"
        echo -e "$DELETED"
    fi
    
    if [[ "n$FAILED" != n ]]
      then
        echo "-----------------"
        echo "FAILED TO DELETE:"
        echo -e "$FAILED"
    fi

}
